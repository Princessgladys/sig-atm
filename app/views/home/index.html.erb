<script type="text/javascript">
  //global variable
    var map;
    var infoWindow = new google.maps.InfoWindow;
    var center = new google.maps.LatLng(-8.67829132, 115.21475983);
    var geocoder;
    var markerDestArr = [];
    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();
    var circle = null;
    var markerArr = [];
    var markerposArr = [];
    var markersrcArr = [];
  //end

  //initialize = fungsi yang akan dipanggil dalam document ready untuk menjalankan fungsi-fungsi lain yang ada di dalamnya.
    function initialize() {
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById("mapsGoogle"), {
        center              : center,
        zoom                : 12,
        disableDefaultUI    : true,
        mapTypeId           : 'roadmap',
      });

      //tampilkan marker ATM
        $.getJSON("home.json",function(data) {
          for(var i=0; i<data.length; i++){
            var point = new google.maps.LatLng(parseFloat(data[i].lat),parseFloat(data[i].lng));
            var nama_atm = data[i].nama_atm;
            var nama_bank = data[i].nama_bank;
            var nama_lokasi = data[i].nama_lokasi;
            var kategori_atm = data[i].nama_kategori;
            var min_transaksi = data[i].nominal;
            var id = data[i].id;
            var icon = data[i].icon;
            var html =  "<b>"+ nama_atm +"</b>"+
                        "<br/>Bank: <b>"+ nama_bank +"</b>"+
                        "<br/>Lokasi: <b>"+ nama_lokasi +"</b>"+
                        "<br/>Kategori: <b>"+ kategori_atm +"</b>"+
                        "<br/>Min Transaksi: <b>"+ min_transaksi +"</b>"+
                        "<hr size='1'>";

            var marker = new google.maps.Marker({
              map: map,
              position: point,
              icon: "assets/"+icon
            });
            
            InfoWindow(marker, map, infoWindow, html, nama_atm);
            markerArr.push({marker:marker, atm:nama_atm, bank:nama_bank, lokasi:nama_lokasi, atm_id:id, poss:point});
          };
        });

        //tampilkan infowindow setiap marker ATM
          function InfoWindow(marker, map, infoWindow, html, nama_atm) {
            google.maps.event.addListener(marker, 'click', function() {
              infoWindow.setContent(html);
              infoWindow.open(map, marker);
              // map.setZoom(15);
              map.setCenter(marker.getPosition());
              $("#latTujuan").val(marker.getPosition().lat());
              $("#lngTujuan").val(marker.getPosition().lng());
              var xx = marker.getPosition().lat();
              var yy = marker.getPosition().lng();
              var endPoint = xx + "," + yy;
              callDistance(endPoint);
              $("#tujuan").html(nama_atm);
              $("#collapseOne").collapse('hide');
              $("#collapseFour").collapse('hide');
              $("#collapseTwo").collapse('show');
            });

            google.maps.event.addListener(map, 'click', function() {
              infoWindow.close();
            });
          };
        //end
      //end

      //untuk menentukan posisi awal dengan click map (Manual Set Location)
      function SetClickMap(){
        google.maps.event.addListener(map, 'click', function(event) {
          clearMarkerDest();
          clearMarkerSrc();
          clearMarkerPos();
          $("#collapseOne").collapse('hide');
          $("#collapseFour").collapse('hide');
          $("#collapseTwo").collapse('show');
          var markerDest = new google.maps.Marker({
              position: event.latLng,
              icon: "assets/user.png",
              map: map
          });
          markerDestArr.push(markerDest);

          $("#latAsal").val(markerDest.getPosition().lat());
          $("#lngAsal").val(markerDest.getPosition().lng());
          var koordinat = new google.maps.LatLng(markerDest.getPosition().lat(), markerDest.getPosition().lng());
          codeLatLng(koordinat);

          callRadius('center', markerDest, 'position')
        });
      };
    //end

    //menentukan posisi awal dengan sensor (Web Location)
      function webLocation() {
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            var markerpos = new google.maps.Marker({
              map: map,
              position: pos,
              icon: "assets/user.png"
            });
            markerposArr.push(markerpos);
            map.setCenter(pos);
            callRadius('center', markerpos, 'position');
            clearMarkerDest();
            clearMarkerSrc();
            $("#collapseOne").collapse('hide');
            $("#collapseFour").collapse('hide');
            $("#collapseTwo").collapse('show');
            $("#latAsal").val(markerpos.getPosition().lat());
            $("#lngAsal").val(markerpos.getPosition().lng());
            var koordinat = new google.maps.LatLng(markerpos.getPosition().lat(), markerpos.getPosition().lng());
            codeLatLng(koordinat);
          },  function() {
                handleNoGeolocation(true);
              });
        }   
        else {
          handleNoGeolocation(false);
        }
      };
    //end

    //menentukan posisi dengan pencarian berdasarkan nama lokasi
      function codeAddress() {
        var address = document.getElementById('address').value;
        geocoder.geocode( { 'address': address}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            var koor = results[0].geometry.location;
            var markersrc = new google.maps.Marker({
              map: map,
              position: koor,
              icon: "assets/user.png"
            });
            markersrcArr.push(markersrc);
            map.setCenter(koor);
            callRadius('center', markersrc, 'position');
            clearMarkerDest();
            clearMarkerPos();
            $("#collapseOne").collapse('hide');
            $("#collapseFour").collapse('hide');
            $("#collapseTwo").collapse('show');
            $("#latAsal").val(markersrc.getPosition().lat());
            $("#lngAsal").val(markersrc.getPosition().lng());
            var koordinat = new google.maps.LatLng(markersrc.getPosition().lat(), markersrc.getPosition().lng());
            codeLatLng(koordinat);
          } else {
              alert('Pencarian tidak berhasil! ' + status);
          }
        });
      }
    //end

    //fungsi untuk menghilangkan marker Posisi awal (Manual/Sensor/Address)
      function clearMarkerDest() {
        for (var i = 0; i < markerDestArr.length; i++ ) {
          markerDestArr[i].setMap(null);
        }
      }

      function clearMarkerPos() {
        for (var i = 0; i < markerposArr.length; i++ ) {
          markerposArr[i].setMap(null);
        }
      }

      function clearMarkerSrc() {
        for (var i = 0; i < markersrcArr.length; i++ ) {
          markersrcArr[i].setMap(null);
        }
      }
    //end

    //radius
      function callRadius(center, marker, position) {
        if($('#setRadius').is(':checked')){ 
          var radiusRange = parseInt(document.getElementById('radius').value, 10)*1000;
        }
        else{
          circle.setMap(null);
        }
        if(radiusRange < 0){
          alert("Tidak dapat memasukkan nilai radius..");
          return false;
        }
        if (circle) circle.setMap(null);
        $("#atmTerdekat li").remove();
        circle = new google.maps.Circle({
          map: map,
          radius: radiusRange,
          strokeColor: "#00f",
          strokeOpacity: 0.3,
          strokeWeight: 2,
          fillColor: "#00f",
          fillOpacity: 0.07
        });
        
        circle.bindTo(center, marker, position);
        
        var myBounds = circle.getBounds();
        for(var i=markerArr.length; i--;){
          if(!myBounds.contains(markerArr[i].marker.getPosition())){
            markerArr[i].marker.setMap(null);
          }
          else{
            markerArr[i].marker.setMap(map);
            $("#atmTerdekat").append("<li><label for='atm"+markerArr[i].atm_id+"' class='checkbox'>"+"<input type='checkbox' name='checkBox' id='atm"+markerArr[i].atm_id+"' data-posisi='"+markerArr[i].poss+"' />"+markerArr[i].atm+"</label></li>");
          }
        };
      };
    //end

    //reverse geocode
      function codeLatLng(koordinat) {
        geocoder.geocode({'latLng': koordinat}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            if (results[1]) {
              document.getElementById("asal").innerHTML = results[1].formatted_address;
            } else {
              alert('No results found');
            }
          } else {
            alert('Geocoder failed due to: ' + status);
          }
        });
      }
    //end

    //filter marker
      function showBank(bank) {
        for (var i=0; i<markerArr.length; i++) {
          if (markerArr[i].bank == bank) {
            markerArr[i].marker.setMap(map);
          }
        }
        document.getElementById(bank+"cbx").checked = true;
      };

      function hideBank(bank) {
        for (var i=0; i<markerArr.length; i++) {
          if (markerArr[i].bank == bank) {
            markerArr[i].marker.setMap(null);
          }
        }
        document.getElementById(bank+"cbx").checked = false;
      };

      function cboxclick(box,bank) {
        if (box.checked) {
          showBank(bank);
        } else {
          hideBank(bank);
        }
      };

      <% Bank.all.each do |bank| %>
        $('#<%= bank.nama_bank %>cbx').click(function () {
          cboxclick(this, '<%= bank.nama_bank %>');
        });
      <% end %>
    //end

    //set location control with radio
      $("#btnSetLocation").click(function(){
        if($('#checkBox').is(':checked')){
          alert("Silahkan tentukan lokasi anda dengan klik pada peta!");
          SetClickMap();
        }
        else if($('#radioWebLocation').is(':checked')){
          webLocation();
        }
        else if($('#radioSearchAdd').is(':checked')){
          codeAddress();
        }
      });
    //

    $("#reloadMap").click(function() {
      // initialize();
      for (var i=0; i<markerArr.length; i++) {
        markerArr[i].marker.setMap(null);
        markerArr[i].marker.setMap(map);
      }
      clearMarkerDest();
      clearMarkerPos();
      clearMarkerSrc();
      if (circle) circle.setMap(null);
      $("#atmTerdekat").html("");
      $(".checkbox-bank").prop('checked', true);
      $("#setRadius").prop('checked', false);
      $("input#radius").val($("input#radius").data("default"));
    });

    //map control
      $("#mapControl").click(function(){
      //for zoom control
        if($('#zoomControl').is(':checked')){
          map.setOptions({zoomControl:true,disableDoubleClickZoom:true});
        }else{
          map.setOptions({zoomControl:false,disableDoubleClickZoom:true});
        }
      //end

      //for pan control
        if($('#panControl').is(':checked')){
          map.setOptions({panControl:true,draggable:true});
        }else{
          map.setOptions({panControl:false,draggable:true});
        }
      //end
      });
    //end
    
    };
  //end

  $(document).ready(function(){
    initialize();

    //tetst
    <% Atm.all.each do |atm| %>
      $("body").on("click", "#atm<%= atm.id %>", function(){
        if($("#atm<%= atm.id %>").is(":checked")){
          var posisiAtmLat = $(this).data("posisi").split(",")[0];
          var posisiAtmLng = $(this).data("posisi").split(",")[1];
          var posisiAtmLatStr = posisiAtmLat.toString();
          var posisiAtmLngStr = posisiAtmLng.toString();
          var posisiAtmLatStrFix = posisiAtmLatStr.slice(1);
          var posisiAtmLngStrFix = posisiAtmLngStr.split(")")[0];
          var koordinatAtm = new google.maps.LatLng(posisiAtmLatStrFix, posisiAtmLngStrFix);
          map.setCenter(koordinatAtm);
        }
      });
    <% end %>
    //end

    $("#centerMap").click(function(){
      var center = new google.maps.LatLng(-8.67829132, 115.21475983);
      map.setCenter(center);
    });

    $("#showRoute").click(function() {
      showRoute();
      $("#collapseTwo").collapse('hide');
      $("#collapseThree").collapse('show');
    });
  });

  directionsDisplay = new google.maps.DirectionsRenderer({
    suppressMarkers: true
  });

  function callDistance(endPoint) {
    directionsDisplay.setMap(null);
    $("#directionsPanel").hide();
    var a = document.getElementById("latAsal").value;
    var b = document.getElementById("lngAsal").value;
    var startPoint = a + "," + b;
    var request = {
      origin: startPoint,
      destination: endPoint,
      provideRouteAlternatives: true,
      travelMode: google.maps.DirectionsTravelMode.DRIVING
    };

    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);

        var route = response.routes[0];
        for (var i = 0; i < route.legs.length; i++) {
          $("#distance").html(route.legs[i].distance.text);
        }
      }
      else {                      
        alert ('Tidak dapat menghitung jarak ATM!, Tentukan lokasi Anda saat ini terlebih dahulu');
      }
    });
  }

  function showRoute() {
    directionsDisplay.setMap(map);
    directionsDisplay.setPanel(document.getElementById("directionsPanel"));
    $("#directionsPanel").show();
    var a = document.getElementById("latAsal").value;
    var b = document.getElementById("lngAsal").value;
    var startPoint = a + "," + b;

    var x = document.getElementById("latTujuan").value;
    var y = document.getElementById("lngTujuan").value;
    var endPoint = x + "," + y;
    var request = {
      origin: startPoint,
      destination: endPoint,
      provideRouteAlternatives: true,
      travelMode: google.maps.DirectionsTravelMode.DRIVING
    };

    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
      else {                      
        directionsDisplay.setMap(null);
        alert ('Pencarian tidak berhasil!');
      }
    });
  }

</script>

<!-- The navbar -->
<%= render "home/navbar_top" %>

<!-- The content -->
<div class="row-fluid">
  <div class="span9">
    <div class="content-map">
      <div id="mapsGoogle"></div>
    </div>
  </div>
  <div class="span3">
    <div class="side-menu">
      <div class="accordion" id="accordion2">
        <%= render "home/map_control" %>
        <%= render "home/atm" %>
        <%= render "home/set_lokasi" %>
        <%= render "home/destinasi" %>
        <%= render "home/hasil" %>
      </div>
    </div>
  </div>
</div>